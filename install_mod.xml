<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--NOTICE: Please open this file in your web browser. If presented with a security warning, you may safely tell it to allow the blocked content.-->
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD.\nAlthough MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD.\nNo support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<meta name="generator" content="MODX file generated with PP MODX Creator by tumba25 (online version)"/>
		<meta name="generator" content="MODX file generated by MODX Generator by tumba25"/>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2]]></license>
		<title lang="en"><![CDATA[MathJax phpBB Integration]]></title>
		<description lang="en"><![CDATA[Integrates MathJax Javascript Library with phpBB to enable [LaTeX] posts.]]></description>
		<author-notes lang="en"><![CDATA[Due to license incompatibilities, this mod doesn't "run" out of the box. 

To get it to work you need to download the MathJax Library (licensed under the Apache 2 License) to your phpBB folder or agree to MathJax CDN Terms Of Service. 

Configuration is done in the "Server Settings" page and can be disabled in the post settings for posts and private messages settings for pm's.]]></author-notes>
		<author-group>
			<author>
				<realname><![CDATA[Sérgio Faria]]></realname>
				<username><![CDATA[sergio91pt]]></username>
				<homepage><![CDATA[https://github.com/sergio91pt/MathJax-phpBB-Integration]]></homepage>
				<email><![CDATA[sergio91pt@gmail.com]]></email>
			</author>
		</author-group>
		<mod-version>0.1.1</mod-version>
		<installation>
			<level>easy</level>
			<time>600</time>
			<target-version>3.0.8</target-version>
		</installation>
		<history>
			<entry>
				<date>2011-07-08</date>
				<rev-version>0.1.1</rev-version>
				<changelog lang="en">
					<change><![CDATA[Fixed 2 wrong variable names on add_table_entries.php]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2011-07-08</date>
				<rev-version>0.1.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Initial Release.]]></change>
				</changelog>
			</entry>
		</history>
		<link-group>
			<link type="language" href="language/pt.xml" lang="pt">Portuguese Translation</link>
		</link-group>
	</header>
	<action-group>
		<copy>
			<file from="/root/umil/*.*" to="umil/*.*"/>
			<file from="/root/add_table_entries.php" to="add_table_entries.php"/>
			<file from="/root/language/en/mods/mathjaxbb.php" to="language/en/mods/mathjaxbb.php"/>
		</copy>
		<open src="posting.php">
			<edit>
				<find><![CDATA[		unset($attachment_data);]]></find>
				<action type="after-add"><![CDATA[	}

	// Check if MathJax is enabled
	if ($config['mathjax_enable_post'] == true)
	{
		if($config['mathjax_use_cdn'] == true)
		{
			$server_protocol = ($config['server_protocol']) ? $config['server_protocol'] : (($config['cookie_secure']) ? 'https://' : 'http://');
			$mathjax_uri = ($server_protocol === 'http://') ? $config['mathjax_cdn'] : $config['mathjax_cdn_ssl'];
		}
		else
		{
			$mathjax_uri = $config['mathjax_uri'];
		}

		$mathjax_uri .= ($config['mathjax_config']) ? '/MathJax.js?config=' . $config['mathjax_config'] : '/MathJax.js';]]></action>
			</edit>
			<edit>
				<find><![CDATA[	'S_BBCODE_QUOTE'		=> $quote_status,]]></find>
				<action type="after-add"><![CDATA[	'S_ENABLE_MATHJAX'		=> (isset($mathjax_uri)) ? true : false,
	'U_MATHJAX'				=> (isset($mathjax_uri)) ? $mathjax_uri : '',]]></action>
			</edit>
		</open>
		<open src="viewtopic.php">
			<edit>
				<find><![CDATA[$topic_data['topic_title'] = censor_text($topic_data['topic_title']);]]></find>
				<action type="after-add"><![CDATA[// Check if MathJax is enabled
if ($config['mathjax_enable_post'] == true)
{
	if($config['mathjax_use_cdn'] == true)
	{
		$server_protocol = ($config['server_protocol']) ? $config['server_protocol'] : (($config['cookie_secure']) ? 'https://' : 'http://');
		$mathjax_uri = ($server_protocol === 'http://') ? $config['mathjax_cdn'] : $config['mathjax_cdn_ssl'];
	}
	else
	{
		$mathjax_uri = $config['mathjax_uri'];
	}

	$mathjax_uri .= ($config['mathjax_config']) ? '/MathJax.js?config=' . $config['mathjax_config'] : '/MathJax.js';
}]]></action>
			</edit>
			<edit>
				<find><![CDATA[	'WARN_IMG'			=> $user->img('icon_user_warn', 'WARN_USER'),]]></find>
				<action type="after-add"><![CDATA[	'S_ENABLE_MATHJAX'		=> (isset($mathjax_uri)) ? true : false,
	'U_MATHJAX'				=> (isset($mathjax_uri)) ? $mathjax_uri : '',]]></action>
			</edit>
		</open>
		<open src="includes/acp/acp_board.php">
			<edit>
				<find><![CDATA[						'auth_flash_pm'			=> array('lang' => 'ALLOW_FLASH_PM',		'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => true),]]></find>
				<action type="after-add"><![CDATA[						'mathjax_enable_pm'		=> array('lang' => 'MATHJAX_ENABLE_PM',		'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => false),]]></action>
			</edit>
			<edit>
				<find><![CDATA[						'allow_post_flash'		=> array('lang' => 'ALLOW_POST_FLASH',		'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => true),]]></find>
				<action type="after-add"><![CDATA[						'mathjax_enable_post'	=> array('lang' => 'MATHJAX_ENABLE_POST',	'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => false),]]></action>
			</edit>
			<edit>
				<find><![CDATA[						'script_path'			=> array('lang' => 'SCRIPT_PATH',		'validate' => 'script_path',	'type' => 'text::255', 'explain' => true),]]></find>
				<action type="after-add"><![CDATA[						'legend4'				=> 'MATHJAX_SETTINGS', 
						'mathjax_use_cdn'		=> array('lang' => 'MATHJAX_USE_CDN',	'validate' => 'bool',	'type' => 'radio:yes_no', 	'explain' => true),
						'mathjax_uri'			=> array('lang' => 'MATHJAX_URI',		'validate' => 'rpath',	'type' => 'text:20:255',	'explain' => true),
						'mathjax_config'		=> array('lang' => 'MATHJAX_CONFIG',	'validate' => 'string',	'type' => 'text:20:255',	'explain' => true),]]></action>
			</edit>
			<edit>
				<find><![CDATA[						'legend4'					=> 'ACP_SUBMIT_CHANGES',]]></find>
				<inline-edit>
					<inline-find><![CDATA[						']]></inline-find>
					<inline-find><![CDATA[legend4]]></inline-find>
					<inline-action type="replace-with"><![CDATA[legend5]]></inline-action>
				</inline-edit>
			</edit>
		</open>
		<open src="includes/ucp/ucp_pm_compose.php">
			<edit>
				<find><![CDATA[		$preview_subject = censor_text($subject);]]></find>
				<action type="after-add"><![CDATA[		// Check if MathJax is enabled
		if ($config['mathjax_enable_pm'] == true)
		{
			if($config['mathjax_use_cdn'] == true)
			{
				$server_protocol = ($config['server_protocol']) ? $config['server_protocol'] : (($config['cookie_secure']) ? 'https://' : 'http://');
				$mathjax_uri = ($server_protocol === 'http://') ? $config['mathjax_cdn'] : $config['mathjax_cdn_ssl'];
			}
			else
			{
				$mathjax_uri = $config['mathjax_uri'];
			}

			$mathjax_uri .= ($config['mathjax_config']) ? '/MathJax.js?config=' . $config['mathjax_config'] : '/MathJax.js';
		}]]></action>
			</edit>
			<edit>
				<find><![CDATA[		'S_BBCODE_URL'			=> $url_status,]]></find>
				<action type="after-add"><![CDATA[		'S_ENABLE_MATHJAX'		=> (isset($mathjax_uri)) ? true : false,
		'U_MATHJAX'				=> (isset($mathjax_uri)) ? $mathjax_uri : '',]]></action>
			</edit>
		</open>
		<open src="includes/ucp/ucp_pm_viewmessage.php">
			<edit>
				<find><![CDATA[	$num_recipients = (int) preg_match_all('/:?(u|g)_([0-9]+):?/', $message_row['to_address'], $match);]]></find>
				<action type="after-add"><![CDATA[	// Check if MathJax is enabled
	if ($config['mathjax_enable_pm'] == true)
	{
		if($config['mathjax_use_cdn'] == true)
		{
			$server_protocol = ($config['server_protocol']) ? $config['server_protocol'] : (($config['cookie_secure']) ? 'https://' : 'http://');
			$mathjax_uri = ($server_protocol === 'http://') ? $config['mathjax_cdn'] : $config['mathjax_cdn_ssl'];
		}
		else
		{
			$mathjax_uri = $config['mathjax_uri'];
		}

		$mathjax_uri .= ($config['mathjax_config']) ? '/MathJax.js?config=' . $config['mathjax_config'] : '/MathJax.js';
	}]]></action>
			</edit>
			<edit>
				<find><![CDATA[		'S_PM_RECIPIENTS'	=> $num_recipients,]]></find>
				<action type="after-add"><![CDATA[		'S_ENABLE_MATHJAX'		=> (isset($mathjax_uri)) ? true : false,
		'U_MATHJAX'				=> (isset($mathjax_uri)) ? $mathjax_uri : '',]]></action>
			</edit>
		</open>
		<open src="language/en/acp/board.php">
			<edit>
				<find><![CDATA[
?>]]></find>
				<action type="before-add"><![CDATA[
$lang = array_merge($lang, array(
	'MATHJAX_ENABLE_PM'			=> 'Allow <code>[LaTeX]</code> in private messages',
	'MATHJAX_ENABLE_POST'				=> 'Allow use of <code>[LaTeX]</code>',
	'MATHJAX_SETTINGS'			=> 'MathJax Integration Settings',
	'MATHJAX_USE_CDN'			=> 'Use Mathjax CDN',
	'MATHJAX_USE_CDN_EXPLAIN'	=> 'By selecting this option, you hereby agree to its <a href="http://www.mathjax.org/download/mathjax-cdn-terms-of-service/" alt="MathJax CDN TOS">TOS</a>.',
	'MATHJAX_URI'				=> 'MathJax Instalation Path',
	'MATHJAX_URI_EXPLAIN'		=> 'Path under your phpBB root directory, e.g. <samp>mathjax/</samp>.',
	'MATHJAX_CONFIG'			=> 'Config file',
	'MATHJAX_CONFIG_EXPLAIN'	=> 'Default is <samp>TeX-AMS-MML_HTMLorMML</samp>. Valid syntax explained in the <a href="http://www.mathjax.org/docs/1.1/configuration.html#using-a-configuration-file" alt="MathJax Docs">Documentation</a>.',
));]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/overall_header.html">
			<edit>
				<find><![CDATA[	<link href="{T_THEME_PATH}/bidi.css" rel="stylesheet" type="text/css" media="screen, projection" />]]></find>
				<action type="after-add"><![CDATA[<!-- ENDIF -->

<!-- IF S_ENABLE_MATHJAX -->
<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
    	tex2jax: {
      		inlineMath: [ ["[latex]", "[/latex]"], ["[LaTeX]", "[/LaTeX]"] ],
      		displayMath: [ ["[latexb]", "[/latexb]"] ],
      		processEscapes: false
    	}
	});
</script>
<script type="text/javascript" src="{U_MATHJAX}"></script>]]></action>
			</edit>
		</open>
		<php-installer><![CDATA[add_table_entries.php]]></php-installer>
		<diy-instructions lang="en"><![CDATA[- Delete add_table_entries.php after executing it.

- Download mathjax, copy it to your phpBB dir and add its path on Server Settings.
- Or go to Server Settings and enable Mathjax CDN.]]></diy-instructions>
		<diy-instructions lang="pt"><![CDATA[- Elimine add_table_entries.php depois de o executar.

- Faça download do mathjax, extrai-a para uma pasta dentro a diretoria do phpBB e adicione o caminho nas definições do servidor.
- Alternativamente, pode simplesmente usar a CDN do Mathjax, ativando essa opção nas defenições do servidor.]]></diy-instructions>
	</action-group>
</mod>
